{"cells":[{"cell_type":"code","execution_count":15,"metadata":{"executionInfo":{"elapsed":604,"status":"ok","timestamp":1607403546026,"user":{"displayName":"Duong Le Nguyen","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gj_oKikuuULhEMHmMpSdaAniE0IT-MHoLjuERqw=s64","userId":"15331333117223727167"},"user_tz":300},"id":"V4UreXjLgkgj"},"outputs":[],"source":["import tensorflow as tf\n","from tensorflow import keras\n","import numpy as np\n","\n","keras.backend.clear_session()\n","tf.random.set_seed(42)\n","np.random.seed(42)\n","\n","#NN with 20 layers, each with 100 neurons\n","model = keras.models.Sequential()\n","model.add(keras.layers.Flatten(input_shape=[32, 32, 3]))\n","for i in range(20):\n","  model.add(keras.layers.Dense(100,activation='elu',kernel_initializer='he_normal'))"]},{"cell_type":"code","execution_count":16,"metadata":{"executionInfo":{"elapsed":1555,"status":"ok","timestamp":1607403549750,"user":{"displayName":"Duong Le Nguyen","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gj_oKikuuULhEMHmMpSdaAniE0IT-MHoLjuERqw=s64","userId":"15331333117223727167"},"user_tz":300},"id":"osujqxgHjfnm"},"outputs":[],"source":["#Load dataset \n","\n","(X_train_full,y_train_full),(X_test,y_test) = keras.datasets.cifar10.load_data()"]},{"cell_type":"code","execution_count":17,"metadata":{"executionInfo":{"elapsed":427,"status":"ok","timestamp":1607403550843,"user":{"displayName":"Duong Le Nguyen","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gj_oKikuuULhEMHmMpSdaAniE0IT-MHoLjuERqw=s64","userId":"15331333117223727167"},"user_tz":300},"id":"fCEZ3RW9jxM_"},"outputs":[],"source":["#Split valid set from training set \n","\n","X_valid,X_train = X_train_full[:5000],X_train_full[5000:]\n","y_valid,y_train = y_train_full[:5000],y_train_full[5000:]"]},{"cell_type":"code","execution_count":18,"metadata":{"executionInfo":{"elapsed":539,"status":"ok","timestamp":1607403552383,"user":{"displayName":"Duong Le Nguyen","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gj_oKikuuULhEMHmMpSdaAniE0IT-MHoLjuERqw=s64","userId":"15331333117223727167"},"user_tz":300},"id":"d0BftvBeky0i"},"outputs":[],"source":["#Add output layer with softmax\n","\n","model.add(keras.layers.Dense(10,activation='softmax'))"]},{"cell_type":"code","execution_count":19,"metadata":{"executionInfo":{"elapsed":339,"status":"ok","timestamp":1607403553581,"user":{"displayName":"Duong Le Nguyen","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gj_oKikuuULhEMHmMpSdaAniE0IT-MHoLjuERqw=s64","userId":"15331333117223727167"},"user_tz":300},"id":"ATeyNV2alQQn"},"outputs":[],"source":["#Nadam optimization\n","\n","optimizer = keras.optimizers.Nadam(lr=5e-5)\n","model.compile(loss='sparse_categorical_crossentropy',optimizer=optimizer,metrics=['accuracy'])"]},{"cell_type":"code","execution_count":20,"metadata":{"executionInfo":{"elapsed":522,"status":"ok","timestamp":1607403555450,"user":{"displayName":"Duong Le Nguyen","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14Gj_oKikuuULhEMHmMpSdaAniE0IT-MHoLjuERqw=s64","userId":"15331333117223727167"},"user_tz":300},"id":"dTbnIcPLpV_r"},"outputs":[],"source":["#Early stopping\n","import os\n","\n","early_stopping_cb=keras.callbacks.EarlyStopping(patience=20)\n","model_checkpoint_cb=keras.callbacks.ModelCheckpoint('my_cifar10_model.h5',save_best_only=True)\n","run_index = 1\n","run_logdir = os.path.join(os.curdir,'my_cifar10_logs',\"run_{:03d}\".format(run_index))\n","tensorboard_cb = keras.callbacks.TensorBoard(run_logdir)\n","callbacks = [early_stopping_cb, model_checkpoint_cb, tensorboard_cb]"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true,"base_uri":"https://localhost:8080/"},"id":"Qb-kgpx0s7ja"},"outputs":[{"name":"stdout","output_type":"stream","text":["Epoch 1/100\n","   2/1407 [..............................] - ETA: 3:15 - loss: 133.4807 - accuracy: 0.1250WARNING:tensorflow:Callbacks method `on_train_batch_end` is slow compared to the batch time (batch time: 0.0176s vs `on_train_batch_end` time: 0.2612s). Check your callbacks.\n","1407/1407 [==============================] - 19s 14ms/step - loss: 4.1505 - accuracy: 0.1645 - val_loss: 2.1512 - val_accuracy: 0.2278\n","Epoch 2/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 2.0620 - accuracy: 0.2442 - val_loss: 2.0026 - val_accuracy: 0.2490\n","Epoch 3/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.9348 - accuracy: 0.2917 - val_loss: 1.9251 - val_accuracy: 0.2912\n","Epoch 4/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.8540 - accuracy: 0.3230 - val_loss: 1.8850 - val_accuracy: 0.3184\n","Epoch 5/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.7953 - accuracy: 0.3482 - val_loss: 1.7782 - val_accuracy: 0.3392\n","Epoch 6/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.7470 - accuracy: 0.3666 - val_loss: 1.7527 - val_accuracy: 0.3582\n","Epoch 7/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.7069 - accuracy: 0.3830 - val_loss: 1.7397 - val_accuracy: 0.3586\n","Epoch 8/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.6679 - accuracy: 0.3957 - val_loss: 1.6730 - val_accuracy: 0.3878\n","Epoch 9/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.6411 - accuracy: 0.4060 - val_loss: 1.6641 - val_accuracy: 0.3884\n","Epoch 10/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.6138 - accuracy: 0.4177 - val_loss: 1.6802 - val_accuracy: 0.3904\n","Epoch 11/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.5920 - accuracy: 0.4249 - val_loss: 1.6668 - val_accuracy: 0.3930\n","Epoch 12/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.5701 - accuracy: 0.4339 - val_loss: 1.6273 - val_accuracy: 0.4110\n","Epoch 13/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.5502 - accuracy: 0.4421 - val_loss: 1.6187 - val_accuracy: 0.4170\n","Epoch 14/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.5316 - accuracy: 0.4488 - val_loss: 1.6035 - val_accuracy: 0.4274\n","Epoch 15/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.5143 - accuracy: 0.4550 - val_loss: 1.5885 - val_accuracy: 0.4242\n","Epoch 16/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.4975 - accuracy: 0.4602 - val_loss: 1.5574 - val_accuracy: 0.4424\n","Epoch 17/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.4862 - accuracy: 0.4644 - val_loss: 1.5750 - val_accuracy: 0.4314\n","Epoch 18/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.4688 - accuracy: 0.4687 - val_loss: 1.5603 - val_accuracy: 0.4442\n","Epoch 19/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.4593 - accuracy: 0.4752 - val_loss: 1.5536 - val_accuracy: 0.4442\n","Epoch 20/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.4438 - accuracy: 0.4816 - val_loss: 1.5814 - val_accuracy: 0.4354\n","Epoch 21/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.4341 - accuracy: 0.4836 - val_loss: 1.5564 - val_accuracy: 0.4412\n","Epoch 22/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.4227 - accuracy: 0.4857 - val_loss: 1.5542 - val_accuracy: 0.4426\n","Epoch 23/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.4075 - accuracy: 0.4933 - val_loss: 1.5693 - val_accuracy: 0.4454\n","Epoch 24/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.3959 - accuracy: 0.4961 - val_loss: 1.5401 - val_accuracy: 0.4486\n","Epoch 25/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.3886 - accuracy: 0.5004 - val_loss: 1.5100 - val_accuracy: 0.4590\n","Epoch 26/100\n","1407/1407 [==============================] - 19s 13ms/step - loss: 1.3764 - accuracy: 0.5032 - val_loss: 1.5492 - val_accuracy: 0.4516\n","Epoch 27/100\n","1407/1407 [==============================] - 21s 15ms/step - loss: 1.3699 - accuracy: 0.5082 - val_loss: 1.5137 - val_accuracy: 0.4626\n","Epoch 28/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.3568 - accuracy: 0.5111 - val_loss: 1.5196 - val_accuracy: 0.4538\n","Epoch 29/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.3503 - accuracy: 0.5140 - val_loss: 1.5123 - val_accuracy: 0.4576\n","Epoch 30/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.3394 - accuracy: 0.5171 - val_loss: 1.5797 - val_accuracy: 0.4504\n","Epoch 31/100\n","1407/1407 [==============================] - 19s 14ms/step - loss: 1.3294 - accuracy: 0.5206 - val_loss: 1.5967 - val_accuracy: 0.4512\n","Epoch 32/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.3213 - accuracy: 0.5239 - val_loss: 1.5031 - val_accuracy: 0.4760\n","Epoch 33/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.3124 - accuracy: 0.5280 - val_loss: 1.5009 - val_accuracy: 0.4708\n","Epoch 34/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.3015 - accuracy: 0.5333 - val_loss: 1.5757 - val_accuracy: 0.4628\n","Epoch 35/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.2935 - accuracy: 0.5334 - val_loss: 1.5330 - val_accuracy: 0.4646\n","Epoch 36/100\n","1407/1407 [==============================] - 18s 12ms/step - loss: 1.2869 - accuracy: 0.5370 - val_loss: 1.5234 - val_accuracy: 0.4694\n","Epoch 37/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.2771 - accuracy: 0.5415 - val_loss: 1.5319 - val_accuracy: 0.4634\n","Epoch 38/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.2687 - accuracy: 0.5421 - val_loss: 1.5206 - val_accuracy: 0.4696\n","Epoch 39/100\n","1407/1407 [==============================] - 18s 12ms/step - loss: 1.2627 - accuracy: 0.5473 - val_loss: 1.5156 - val_accuracy: 0.4656\n","Epoch 40/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.2512 - accuracy: 0.5497 - val_loss: 1.5494 - val_accuracy: 0.4604\n","Epoch 41/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.2452 - accuracy: 0.5538 - val_loss: 1.5193 - val_accuracy: 0.4720\n","Epoch 42/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.2397 - accuracy: 0.5551 - val_loss: 1.5372 - val_accuracy: 0.4730\n","Epoch 43/100\n","1407/1407 [==============================] - 18s 12ms/step - loss: 1.2300 - accuracy: 0.5576 - val_loss: 1.5226 - val_accuracy: 0.4704\n","Epoch 44/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.2236 - accuracy: 0.5595 - val_loss: 1.5490 - val_accuracy: 0.4704\n","Epoch 45/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.2143 - accuracy: 0.5616 - val_loss: 1.5416 - val_accuracy: 0.4708\n","Epoch 46/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.2065 - accuracy: 0.5657 - val_loss: 1.5233 - val_accuracy: 0.4738\n","Epoch 47/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.2032 - accuracy: 0.5670 - val_loss: 1.5268 - val_accuracy: 0.4788\n","Epoch 48/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.1935 - accuracy: 0.5706 - val_loss: 1.5565 - val_accuracy: 0.4618\n","Epoch 49/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.1835 - accuracy: 0.5735 - val_loss: 1.5341 - val_accuracy: 0.4814\n","Epoch 50/100\n","1407/1407 [==============================] - 18s 12ms/step - loss: 1.1785 - accuracy: 0.5776 - val_loss: 1.5557 - val_accuracy: 0.4674\n","Epoch 51/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.1754 - accuracy: 0.5778 - val_loss: 1.5459 - val_accuracy: 0.4708\n","Epoch 52/100\n","1407/1407 [==============================] - 18s 13ms/step - loss: 1.1659 - accuracy: 0.5799 - val_loss: 1.5834 - val_accuracy: 0.4618\n","Epoch 53/100\n","1407/1407 [==============================] - 17s 12ms/step - loss: 1.1566 - accuracy: 0.5856 - val_loss: 1.5982 - val_accuracy: 0.4542\n"]},{"data":{"text/plain":["\u003ctensorflow.python.keras.callbacks.History at 0x7f81c8e5cb00\u003e"]},"execution_count":null,"metadata":{},"output_type":"execute_result"}],"source":["#Train model \n","\n","model.fit(X_train,y_train,epochs=100,\n","          validation_data=(X_valid,y_valid),\n","          callbacks = callbacks)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"uYJjePQItdbF"},"outputs":[],"source":["model = keras.models.load_model('my_cifar10_model.h5')\n","model.evaluate(X_valid,y_valid)"]}],"metadata":{"colab":{"authorship_tag":"ABX9TyNNl2/h1M6SCIzT6auUxdwy","name":"CIFAR10","version":""},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}